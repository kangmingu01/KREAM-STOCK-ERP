<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.OrdersMapper">

    <!-- 발주 정보 등록 -->
    <insert id="insertOrders">
        <selectKey resultType="int" keyProperty="ordersId" order="BEFORE">
            select orders_seq.nextval from dual
        </selectKey>
        insert into orders values (#{ordersId}, sysdate, #{userid}, #{supplierId}, #{productId},
        	 #{ordersQuantity}, #{productPrice}, #{deliveryDate}, 1)
    </insert>
   
	<!-- 제품 정보 개수 조회 (페이징 처리를 위한 전체 개수) -->
    <select id="selectProductCount" resultType="int">
        select count(*) from product
        <where>
            <if test="productName != null and productName != ''">
                product_name like '%' || #{productName} || '%'
            </if>
            <if test="brand != null and brand != ''">
                and SUBSTR(product_category, 1, 2) = #{brand}
            </if>
        </where>
    </select>

    <!-- 제품 정보 리스트 조회 (페이징 처리 및 검색 기능 포함) -->
	<select id="selectProductList" resultType="Product">
    	select * from (select rownum rn, product.* from (
            select product_id, product_category, product_name, product_price, delivery_price, product_img from product
            <where>
                <if test="productName != null and productName != ''">
                    product_name like '%' || #{productName} || '%'
                </if>
                <if test="brand != null and brand != ''">
                    AND SUBSTR(product_category, 1, 2) = #{brand}
                </if>
            </where>
            order by product_id desc) product) where rn between #{startRow} and #{endRow}
	</select>

    <!-- 공급 업체 이름 목록 조회 -->
    <select id="selectSupplierList" resultType="Supplier">
        select supplier_id, supplier_name from supplier order by supplier_name 
    </select>
    
    <!-- 
    <select id="getSupplierListByKeyword" parameterType="String" resultType="Supplier">
    	select supplier_id, supplier_name from supplier where supplier_name like '%' || #{keyword} || '%' order by supplier_name
	</select>
	-->
    
    <!-- 전체 발주 목록 조회 -->
    <select id="selectAllOrders" resultType="Orders">
	    SELECT o.orders_id, o.orders_date, o.userid, o.supplier_id, o.product_id, o.orders_quantity,
	           o.product_price, o.delivery_date, o.orders_status, p.product_name, p.product_category,
	           s.supplier_name
	    FROM orders o
	    JOIN product p ON o.product_id = p.product_id
	    JOIN supplier s ON o.supplier_id = s.supplier_id
	    ORDER BY o.orders_date DESC
	</select>
	
	<!-- 특정 발주 정보 조회 -->
    <select id="selectOrdersById" parameterType="int" resultType="Orders">
        SELECT o.orders_id, o.orders_date, o.userid, o.supplier_id, o.product_id, o.orders_quantity,
               o.product_price, o.delivery_date, o.orders_status, p.product_name, p.product_category,
               s.supplier_name
        FROM orders o
        JOIN product p ON o.product_id = p.product_id
        JOIN supplier s ON o.supplier_id = s.supplier_id
        WHERE o.orders_id = #{ordersId}
    </select>
    
</mapper>